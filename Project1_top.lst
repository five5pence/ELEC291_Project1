                  2   $LIST
0000              4   
0000              5   
0000              6   
0000              7   ;  N76E003 pinout:
0000              8   ;                               -------
0000              9   ;       PWM2/IC6/T0/AIN4/P0.5 -|1    20|- P0.4/AIN5/STADC/PWM3/IC3
0000             10   ;               TXD/AIN3/P0.6 -|2    19|- P0.3/PWM5/IC5/AIN6
0000             11   ;               RXD/AIN2/P0.7 -|3    18|- P0.2/ICPCK/OCDCK/RXD_1/[SCL]
0000             12   ;                    RST/P2.0 -|4    17|- P0.1/PWM4/IC4/MISO
0000             13   ;        INT0/OSCIN/AIN1/P3.0 -|5    16|- P0.0/PWM3/IC3/MOSI/T1
0000             14   ;              INT1/AIN0/P1.7 -|6    15|- P1.0/PWM2/IC2/SPCLK
0000             15   ;                         GND -|7    14|- P1.1/PWM1/IC1/AIN7/CLO
0000             16   ;[SDA]/TXD_1/ICPDA/OCDDA/P1.6 -|8    13|- P1.2/PWM0/IC0
0000             17   ;                         VDD -|9    12|- P1.3/SCL/[STADC]
0000             18   ;            PWM5/IC7/SS/P1.5 -|10   11|- P1.4/SDA/FB/PWM1
0000             19   ;                               -------
0000             20   ;
0000             21   ;  N76E003 pinout:
0000             22   ;                               ----
0000             23   ;                 (FREE) P0.5 -|1    20|- P0.4 (FREE)
0000             24   ;      Serial to COM TXD/P0.6 -|2    19|- P0.3 LCD.3
0000             25   ;      Serial to COM RXD/P0.7 -|3    18|- P0.2 LCD.2
0000             26   ;                    RST P2.0 -|4    17|- P0.1 LCD.1
0000             27   ;            LM335 INPUT P3.0 -|5    16|- P0.0 LCD.0
0000             28   ;       PUSHBUTTONS AIN0/P1.7 -|6    15|- P1.0 (FREE)
0000             29   ;                         GND -|7    14|- P1.1 THERMOCOUPLE INPUT
0000             30   ;         SPEAKER OUTPUT P1.6 -|8    13|- P1.2 OVEN CONTROL PIN
0000             31   ;                         VDD -|9    12|- P1.3 LCD RS
0000             32   ;                 (FREE) P1.5 -|10   11|- P1.4 LCD E
0000             33   ;                               -------
0000             34   ;
0000             35   CLK               EQU 16600000 ; Microcontroller system frequency in Hz
0000             36   BAUD              EQU 115200 ; Baud rate of UART in bps
0000             37   TIMER1_RELOAD     EQU (0x100-(CLK/(16*BAUD)))
0000             38   TIMER0_RELOAD_1MS EQU (0x10000-(CLK/1000))
0000             39   
0000             40   TIMER2_RATE         EQU 100      ; 100Hz or 10ms
0000             41   TIMER2_RELOAD       EQU (65536-(CLK/(16*TIMER2_RATE))) ; Need to change timer 2 input divide to 16 in T2MOD
0000             42   
0000             43   
0000             44   ;pwn
0000             45   PWM_OUT    EQU P1.2 ; Logic 1=oven on
0000             46   
0000             47   ORG 0x0000
0000 0205C4      48       ljmp main
002B             49   ORG 0x002B
002B 020447      50            ljmp Timer2_ISR
002E             51   ; Initialization Messages
002E 4F3D2020    52   temperature_message:     db 'O=       J=     ', 0
     20202020
     204A3D20
     20202020
     00
003F 2C00        53   comma              :     db ','               , 0
0041 7300        54   soak_message       :     db 's'               , 0
0043 7200        55   reflow_message     :     db 'r'               , 0
0045             56   
0045 3000        57   state0:     db '0', 0
0047 3100        58   state1:     db '1', 0
0049 3200        59   state2:     db '2', 0
004B 3300        60   state3:     db '3', 0
004D 3400        61   state4:     db '4', 0
004F 3500        62   state5:     db '5', 0
0051             63   
0051             64   cseg
0051             65   
0051             66   ; SYMBOLIC CONSTANTS
0051             67   
0051             68   ; INPUTS
0051             69   tempsensor_in equ P3.0
0051             70   thermocouple_in equ P1.1
0051             71   
0051             72   ; OUTPUTS
0051             73   oven_out equ P1.2
0051             74   speaker_out equ P1.6
0051             75   
0051             76   CSEG
0051             77   ; LCD
0051             78   LCD_RS equ P1.3
0051             79   LCD_E equ P1.4
0051             80   LCD_D4 equ P0.0
0051             81   LCD_D5 equ P0.1
0051             82   LCD_D6 equ P0.2
0051             83   LCD_D7 equ P0.3
0051             84   
                 86   	$LIST
0105             88   
0105             89   ; Flash instructions
0105             90   PAGE_ERASE_AP   EQU 00100010b
0105             91   BYTE_PROGRAM_AP EQU 00100001b
0105             92   
0105             93   ; These register definitions needed by 'math32.inc'
0030             94   DSEG at 30H
0030             95   x:   ds 4
0034             96   y:   ds 4
0038             97   amb_temp: ds 4 ; ambient temperature read by LM335
003C             98   bcd: ds 5
0041             99   
0041            100   DSEG
0041            101   pwm: ds 1
0042            102   state: ds 1
0043            103   temp_soak: ds 1
0044            104   Time_soak: ds 1
0045            105   Temp_refl: ds 1
0046            106   Time_refl: ds 1
0047            107   
0047            108   sec: ds 1
0048            109   loop_ten_times: ds 1
0049            110   temp: ds 2
004B            111   
004B            112   
004B            113   FSM1_state: ds 1
004C            114   
004C            115   
004C            116   ;for pwm
004C            117   pwm_counter:  ds 1 ; Free running counter 0, 1, 2, ..., 100, 0
004D            118   
004D            119   seconds:      ds 1 ; a seconds counter attached to Timer 2 ISR
004E            120   
004E            121   
0000            122   BSEG
0000            123   reflow_flag: dbit 1
0001            124   soak_flag: dbit 1
0002            125   mf: dbit 1
0003            126   
0003            127   ; These eight bit variables store the value of the pushbuttons after calling 'ADC_to_PB' below
0003            128   PB0: dbit 1
0004            129   PB1: dbit 1
0005            130   PB2: dbit 1
0006            131   PB3: dbit 1
0007            132   PB4: dbit 1
0008            133   PB5: dbit 1
0009            134   PB6: dbit 1
000A            135   PB7: dbit 1
000B            136   
000B            137   
000B            138   BSEG
000B            139   s_flag: dbit 1 ; set to 1 every time a second has passed
000C            140   
000C            141   
000C            142   ; MATH32
                546   $LIST
                144   $LIST
0375            146   
0375            147   ; Blank Macro
                148   Left_blank mac
                149   	mov a, %0
                150   	anl a, #0xf0
                151   	swap a
                152   	jz Left_blank_%M_a
                153   	ljmp %1
                154   Left_blank_%M_a:
                155   	Display_char(#' ')
                156   	mov a, %0
                157   	anl a, #0x0f
                158   	jz Left_blank_%M_b
                159   	ljmp %1
                160   Left_blank_%M_b:
                161   	Display_char(#' ')
                162   endmac
0375            163   
0375            164   
0375            165   ;binary to display 3 digits on lcd screen
0375            166   
0375            167   SendToLCD:
0375 75F064     168            mov b, #100
0378 84         169            div ab
0379 4430       170            orl a, #0x30
037B 1200A0     171            lcall ?WriteData
037E E5F0       172            mov a,b
0380 75F00A     173            mov b,#10
0383 84         174            div ab
0384 4430       175            orl a, #0x30
0386 1200A0     176            lcall ?WriteData
0389 E5F0       177            mov a, b
038B 4430       178            orl a, #0x30
038D 1200A0     179            lcall ?WriteData
0390 22         180            ret
0391            181   
0391            182   
0391            183   ; Formatting to display thermocouple temperature
0391            184   ; Display: 0000.00
0391            185   Display_formated_BCD_To:
0391 C000       186            push ar0
0393 A83F       186            mov r0, bcd+3
0395 1200EF     186            lcall ?Display_BCD
0398 D000       186            pop ar0
039A C000       187            push ar0
039C A83E       187            mov r0, bcd+2
039E 1200EF     187            lcall ?Display_BCD
03A1 D000       187            pop ar0
03A3 C0E0       188            push acc
03A5 742E       188            mov a, #'.'
03A7 1200A0     188            lcall ?WriteData
03AA D0E0       188            pop acc
03AC C000       189            push ar0
03AE A83D       189            mov r0, bcd+1
03B0 1200EF     189            lcall ?Display_BCD
03B3 D000       189            pop ar0
03B5            190   
03B5            191   
03B5 22         192            ret
03B6            193            
03B6            194   ; Formatting to display ambient temperature
03B6            195   ; Display: 00.00
03B6            196   Display_formated_BCD_Tj:
03B6 C000       197            push ar0
03B8 A83E       197            mov r0, bcd+2
03BA 1200EF     197            lcall ?Display_BCD
03BD D000       197            pop ar0
03BF C0E0       198            push acc
03C1 742E       198            mov a, #'.'
03C3 1200A0     198            lcall ?WriteData
03C6 D0E0       198            pop acc
03C8 C000       199            push ar0
03CA A83D       199            mov r0, bcd+1
03CC 1200EF     199            lcall ?Display_BCD
03CF D000       199            pop ar0
03D1 22         200            ret
03D2            201   
03D2            202   
03D2            203   ; INITIALIZATION SUBROUTINES
03D2            204   Init_All:
03D2            205            ; Configure all the pins for biderectional I/O
03D2 75AC00     206            mov     P3M1, #0x00
03D5 75AD00     207            mov     P3M2, #0x00
03D8 75B300     208            mov     P1M1, #0x00
03DB 75B400     209            mov     P1M2, #0x00
03DE 75B100     210            mov     P0M1, #0x00
03E1 75B200     211            mov     P0M2, #0x00
03E4            212   
03E4 438E10     213            orl     CKCON, #0x10 ; CLK is the input for timer 1
03E7 438780     214            orl     PCON, #0x80 ; Bit SMOD=1, double baud rate
03EA 759852     215            mov     SCON, #0x52
03ED 53C4DF     216            anl     T3CON, #0b11011111
03F0 53890F     217            anl     TMOD, #0x0F ; Clear the configuration bits for timer 1
03F3 438920     218            orl     TMOD, #0x20 ; Timer 1 Mode 2
03F6 758DF7     219            mov     TH1, #TIMER1_RELOAD ; TH1=TIMER1_RELOAD;
03F9 D28E       220            setb TR1
03FB            221            
03FB            222            ; Using timer 0 for delay functions.  Initialize here:
03FB C28C       223            clr     TR0 ; Stop timer 0
03FD 438E08     224            orl     CKCON,#0x08 ; CLK is the input for timer 0
0400 5389F0     225            anl     TMOD,#0xF0 ; Clear the configuration bits for timer 0
0403 438901     226            orl     TMOD,#0x01 ; Timer 0 in Mode 1: 16-bit timer
0406            227            
0406            228            
0406            229            ;Timer 2 for pulse
0406            230            ; Initialize timer 2 for periodic interrupts
0406 75C800     231            mov T2CON, #0 ; Stop timer/counter.  Autoreload mode.
0409 75CDD7     232            mov TH2, #high(TIMER2_RELOAD)
040C 75CC79     233            mov TL2, #low(TIMER2_RELOAD)
040F            234            ; Set the reload value
040F 75C9A0     235            mov T2MOD, #0b1010_0000 ; Enable timer 2 autoreload, and clock divider is 16
0412 75CBD7     236            mov RCMP2H, #high(TIMER2_RELOAD)
0415 75CA79     237            mov RCMP2L, #low(TIMER2_RELOAD)
0418            238            ; Init the free running 10 ms counter to zero
0418 754C00     239            mov pwm_counter, #0
041B            240            ; Enable the timer and interrupts
041B 439B80     241            orl EIE, #0x80 ; Enable timer 2 interrupt ET2=1
041E D2CA       242       setb TR2  ; Enable timer 2
0420            243   
0420 D2AF       244            setb EA ; Enable global interrupts
0422            245            
0422            246            
0422            247            
0422            248            ; Initialize the pin used by the ADC (P1.1) as input.
0422 43B302     249            orl     P1M1, #0b00000010
0425 53B4FD     250            anl     P1M2, #0b11111101
0428            251   
0428            252            ; Initialize the pin used by the ADC (P3.0) as input.
0428 43AC01     253            orl     P3M1, #0b00000001
042B 53ADFE     254            anl     P3M2, #0b11111110
042E            255            
042E            256            ; Initialize and start the ADC:
042E 53E8F0     257            anl ADCCON0, #0xF0
0431 43E807     258            orl ADCCON0, #0x07 ; Select channel 7
0434            259   
0434 53E2F0     260            anl ADCCON2, #0xF0
0437 43E201     261            orl ADCCON2, #0x01 ; Select channel 1
043A            262   
043A            263            ; AINDIDS select if some pins are analog inputs or digital I/O:
043A 75F600     264            mov AINDIDS, #0x00 ; Disable all analog inputs
043D 43F680     265            orl AINDIDS, #0b10000000 ; P1.1 is analog input
0440 43F601     266            orl AINDIDS, #0b00000001 ; P3.0 is analog input
0443 43E101     267            orl ADCCON1, #0x01 ; Enable ADC
0446            268            
0446 22         269            ret
0447            270            
0447            271            
0447            272   ;---------------------------------;
0447            273   ; ISR for timer 2                 ;
0447            274   ;---------------------------------;
0447            275   Timer2_ISR:
0447 C2CF       276            clr TF2  ; Timer 2 doesn't clear TF2 automatically. Do it in the ISR.  It is bit addressable.
0449 C0D0       277            push psw
044B C0E0       278            push acc
044D            279            
044D 054C       280            inc pwm_counter
044F C3         281            clr c
0450 E541       282            mov a, pwm
0452 954C       283            subb a, pwm_counter ; If pwm_counter <= pwm then c=1
0454 B3         284            cpl c
0455 9292       285            mov PWM_OUT, c
0457            286            
0457 E54C       287            mov a, pwm_counter
0459 B46407     288            cjne a, #100, Timer2_ISR_done
045C 754C00     289            mov pwm_counter, #0
045F 054D       290            inc seconds ; It is super easy to keep a seconds count here
0461 D20B       291            setb s_flag
0463            292   
0463            293   Timer2_ISR_done:
0463 D0E0       294            pop acc
0465 D0D0       295            pop psw
0467 32         296            reti
0468            297   
0468            298   ; Flash Memory Subroutines
0468            299   ;******************************************************************************
0468            300   ; This code illustrates how to use IAP to make APROM 3f80h as a byte of
0468            301   ; Data Flash when user code is executed in APROM.
0468            302   ; (The base of this code is listed in the N76E003 user manual)
0468            303   ;******************************************************************************
0468            304   
0468            305   Save_Variables:
0468 C2AF       306            CLR EA  ; MUST disable interrupts for this to work!
046A            307            
046A 75C7AA     308            MOV TA, #0aah ; CHPCON is TA protected
046D 75C755     309            MOV TA, #55h
0470 439F01     310            ORL CHPCON, #00000001b ; IAPEN = 1, enable IAP mode
0473            311            
0473 75C7AA     312            MOV TA, #0aah ; IAPUEN is TA protected
0476 75C755     313            MOV TA, #55h
0479 43A501     314            ORL IAPUEN, #00000001b ; APUEN = 1, enable APROM update
047C            315            
047C 75AF22     316            MOV IAPCN, #PAGE_ERASE_AP ; Erase page 3f80h~3f7Fh
047F 75A73F     317            MOV IAPAH, #3fh ; Address high byte
0482 75A680     318            MOV IAPAL, #80h ; Address low byte
0485 75AEFF     319            MOV IAPFD, #0FFh ; Data to load into the address byte
0488 75C7AA     320            MOV TA, #0aah ; IAPTRG is TA protected
048B 75C755     321            MOV TA, #55h
048E 43A401     322            ORL IAPTRG, #00000001b ; write ?1? to IAPGO to trigger IAP process
0491            323            
0491 75AF21     324            MOV IAPCN, #BYTE_PROGRAM_AP
0494 75A73F     325            MOV IAPAH, #3fh
0497            326            
0497            327            ;Load 3f80h with temp_soak
0497 75A680     328            MOV IAPAL, #80h
049A 8543AE     329            MOV IAPFD, temp_soak
049D 75C7AA     330            MOV TA, #0aah
04A0 75C755     331            MOV TA, #55h
04A3 43A401     332            ORL IAPTRG,#00000001b ; Basically, this executes the write to flash memory
04A6            333            
04A6            334            ;Load 3f81h with Time_soak
04A6 75A681     335            MOV IAPAL, #81h
04A9 8544AE     336            MOV IAPFD, Time_soak
04AC 75C7AA     337            MOV TA, #0aah
04AF 75C755     338            MOV TA, #55h
04B2 43A401     339            ORL IAPTRG,#00000001b
04B5            340            
04B5            341            ;Load 3f82h with Temp_refl
04B5 75A682     342            MOV IAPAL, #82h
04B8 8545AE     343            MOV IAPFD, Temp_refl
04BB 75C7AA     344            MOV TA, #0aah
04BE 75C755     345            MOV TA, #55h
04C1 43A401     346            ORL IAPTRG,#00000001b
04C4            347            
04C4            348            ;Load 3f83h with Time_refl
04C4 75A683     349            MOV IAPAL, #83h
04C7 8546AE     350            MOV IAPFD, Time_refl
04CA 75C7AA     351            MOV TA, #0aah
04CD 75C755     352            MOV TA, #55h
04D0 43A401     353            ORL IAPTRG,#00000001b
04D3            354   
04D3            355            ;Load 3f84h with 55h
04D3 75A684     356            MOV IAPAL,#84h
04D6 75AE55     357            MOV IAPFD, #55h
04D9 75C7AA     358            MOV TA, #0aah
04DC 75C755     359            MOV TA, #55h
04DF 43A401     360            ORL IAPTRG, #00000001b
04E2            361   
04E2            362            ;Load 3f85h with aah (spacer value indicating EOF, will load if something funny happens)
04E2 75A685     363            MOV IAPAL, #85h
04E5 75AEAA     364            MOV IAPFD, #0aah
04E8 75C7AA     365            MOV TA, #0aah
04EB 75C755     366            MOV TA, #55h
04EE 43A401     367            ORL IAPTRG, #00000001b
04F1            368   
04F1 75C7AA     369            MOV TA, #0aah
04F4 75C755     370            MOV TA, #55h
04F7 53A5FE     371            ANL IAPUEN, #11111110b ; APUEN = 0, disable APROM update
04FA 75C7AA     372            MOV TA, #0aah
04FD 75C755     373            MOV TA, #55h
0500 539FFE     374            ANL CHPCON, #11111110b ; IAPEN = 0, disable IAP mode
0503            375            
0503 D2AF       376            setb EA  ; Re-enable interrupts
0505            377   
0505 22         378            ret
0506            379   
0506            380   Load_Variables:
0506 903F84     381            mov dptr, #0x3f84  ; First key value location.  Must be 0x55
0509 E4         382            clr a
050A 93         383            movc a, @a+dptr
050B B4551D     384            cjne a, #0x55, Load_Defaults
050E A3         385            inc dptr      ; Second key value location.  Must be 0xaa
050F E4         386            clr a
0510 93         387            movc a, @a+dptr
0511 B4AA17     388            cjne a, #0xaa, Load_Defaults
0514            389            
0514 903F80     390            mov dptr, #0x3f80
0517 E4         391            clr a
0518 93         392            movc a, @a+dptr
0519 F543       393            mov temp_soak, a
051B            394            
051B A3         395            inc dptr
051C E4         396            clr a
051D 93         397            movc a, @a+dptr
051E F544       398            mov Time_soak, a
0520            399            
0520 A3         400            inc dptr
0521 E4         401            clr a
0522 93         402            movc a, @a+dptr
0523 F545       403            mov Temp_refl, a
0525            404            
0525 A3         405            inc dptr
0526 E4         406            clr a
0527 93         407            movc a, @a+dptr
0528 F546       408            mov Time_refl, a
052A 22         409            ret
052B            410   
052B            411   Load_Defaults:
052B 754301     412            mov temp_soak, #1
052E 754402     413            mov Time_soak, #2
0531 754503     414            mov Temp_refl, #3
0534 754604     415            mov Time_refl, #4
0537 22         416            ret
0538            417   
0538            418   putchar:
0538 3099FD     419       jnb TI, putchar
053B C299       420       clr TI
053D F599       421       mov SBUF, a
053F 22         422       ret
0540            423            
0540            424   
0540            425   wait_1ms:
0540 C28C       426            clr     TR0 ; Stop timer 0
0542 C28D       427            clr     TF0 ; Clear overflow flag
0544 758CBF     428            mov     TH0, #high(TIMER0_RELOAD_1MS)
0547 758A28     429            mov     TL0,#low(TIMER0_RELOAD_1MS)
054A D28C       430            setb TR0
054C 308DFD     431            jnb     TF0, $ ; Wait for overflow
054F 22         432            ret
0550            433   
0550            434   ; Wait the number of miliseconds in R2
0550            435   waitms:
0550 120540     436            lcall wait_1ms
0553 DAFB       437            djnz R2, waitms
0555 22         438            ret
0556            439   
0556            440   ADC_to_PB:
0556 53E8F0     441            anl ADCCON0, #0xF0
0559 43E800     442            orl ADCCON0, #0x00 ; Select AIN0
055C            443            
055C C2EF       444            clr ADCF
055E D2EE       445            setb ADCS   ; ADC start trigger signal
0560 30EFFD     446       jnb ADCF, $ ; Wait for conversion complete
0563            447   
0563 D20A       448            setb PB7
0565 D209       449            setb PB6
0567 D208       450            setb PB5
0569 D207       451            setb PB4
056B D206       452            setb PB3
056D D205       453            setb PB2
056F D204       454            setb PB1
0571 D203       455            setb PB0
0573            456            
0573            457            ; Check PB7
0573            458   ADC_to_PB_L7:
0573 C3         459            clr c
0574 E5C3       460            mov a, ADCRH
0576 94F0       461            subb a, #0xf0
0578 4003       462            jc ADC_to_PB_L6
057A C20A       463            clr PB7
057C 22         464            ret
057D            465   
057D            466            ; Check PB6
057D            467   ADC_to_PB_L6:
057D C3         468            clr c
057E E5C3       469            mov a, ADCRH
0580 94D0       470            subb a, #0xd0
0582 4003       471            jc ADC_to_PB_L5
0584 C209       472            clr PB6
0586 22         473            ret
0587            474   
0587            475            ; Check PB5
0587            476   ADC_to_PB_L5:
0587 C3         477            clr c
0588 E5C3       478            mov a, ADCRH
058A 94B0       479            subb a, #0xb0
058C 4003       480            jc ADC_to_PB_L4
058E C208       481            clr PB5
0590 22         482            ret
0591            483   
0591            484            ; Check PB4
0591            485   ADC_to_PB_L4:
0591 C3         486            clr c
0592 E5C3       487            mov a, ADCRH
0594 9490       488            subb a, #0x90
0596 4003       489            jc ADC_to_PB_L3
0598 C207       490            clr PB4
059A 22         491            ret
059B            492   
059B            493            ; Check PB3
059B            494   ADC_to_PB_L3:
059B C3         495            clr c
059C E5C3       496            mov a, ADCRH
059E 9470       497            subb a, #0x70
05A0 4003       498            jc ADC_to_PB_L2
05A2 C206       499            clr PB3
05A4 22         500            ret
05A5            501   
05A5            502            ; Check PB2
05A5            503   ADC_to_PB_L2:
05A5 C3         504            clr c
05A6 E5C3       505            mov a, ADCRH
05A8 9450       506            subb a, #0x50
05AA 4003       507            jc ADC_to_PB_L1
05AC C205       508            clr PB2
05AE 22         509            ret
05AF            510   
05AF            511            ; Check PB1
05AF            512   ADC_to_PB_L1:
05AF C3         513            clr c
05B0 E5C3       514            mov a, ADCRH
05B2 9430       515            subb a, #0x30
05B4 4003       516            jc ADC_to_PB_L0
05B6 C204       517            clr PB1
05B8 22         518            ret
05B9            519   
05B9            520            ; Check PB0
05B9            521   ADC_to_PB_L0:
05B9 C3         522            clr c
05BA E5C3       523            mov a, ADCRH
05BC 9410       524            subb a, #0x10
05BE 4003       525            jc ADC_to_PB_Done
05C0 C203       526            clr PB0
05C2 22         527            ret
05C3            528            
05C3            529   ADC_to_PB_Done:
05C3            530            ; No puhsbutton pressed         
05C3 22         531            ret
05C4            532   
05C4            533   ; MAIN 
05C4            534   main:
05C4 75817F     535            mov sp, #0x7f
05C7 1203D2     536       lcall Init_All
05CA 1200AA     537       lcall LCD_4BIT
05CD            538       ; initial messages in LCD
05CD C0E0       539            push acc
05CF 7401       539            mov a, #1
05D1 14         539            dec a
05D2 1200EA     539            lcall ?Set_Cursor_1 ; Select column and row
05D5 D0E0       539            pop acc
05D7 C083       540            push dph
05D9 C082       540            push dpl
05DB C0E0       540            push acc
05DD 90002E     540            mov dptr, #temperature_message
05E0 1200DD     540            lcall ?Send_Constant_String
05E3 D0E0       540            pop acc
05E5 D082       540            pop dpl
05E7 D083       540            pop dph
05E9 C0E0       541            push acc
05EB 7401       541            mov a, #1
05ED 14         541            dec a
05EE 1200E8     541            lcall ?Set_Cursor_2 ; Select column and row
05F1 D0E0       541            pop acc
05F3 C083       542            push dph
05F5 C082       542            push dpl
05F7 C0E0       542            push acc
05F9 900043     542            mov dptr, #reflow_message
05FC 1200DD     542            lcall ?Send_Constant_String
05FF D0E0       542            pop acc
0601 D082       542            pop dpl
0603 D083       542            pop dph
0605 C0E0       543            push acc
0607 7405       543            mov a, #5
0609 14         543            dec a
060A 1200E8     543            lcall ?Set_Cursor_2 ; Select column and row
060D D0E0       543            pop acc
060F C083       544            push dph
0611 C082       544            push dpl
0613 C0E0       544            push acc
0615 90003F     544            mov dptr, #comma
0618 1200DD     544            lcall ?Send_Constant_String
061B D0E0       544            pop acc
061D D082       544            pop dpl
061F D083       544            pop dph
0621 C0E0       545            push acc
0623 7408       545            mov a, #8
0625 14         545            dec a
0626 1200E8     545            lcall ?Set_Cursor_2 ; Select column and row
0629 D0E0       545            pop acc
062B C083       546            push dph
062D C082       546            push dpl
062F C0E0       546            push acc
0631 900041     546            mov dptr, #soak_message
0634 1200DD     546            lcall ?Send_Constant_String
0637 D0E0       546            pop acc
0639 D082       546            pop dpl
063B D083       546            pop dph
063D C0E0       547            push acc
063F 740C       547            mov a, #12
0641 14         547            dec a
0642 1200E8     547            lcall ?Set_Cursor_2 ; Select column and row
0645 D0E0       547            pop acc
0647            547   
0647 C083       548            push dph
0649 C082       548            push dpl
064B C0E0       548            push acc
064D 90003F     548            mov dptr, #comma
0650 1200DD     548            lcall ?Send_Constant_String
0653 D0E0       548            pop acc
0655 D082       548            pop dpl
0657 D083       548            pop dph
0659            549   
0659 754B00     550            mov FSM1_state, #0
065C 754364     551       mov Temp_soak, #100
065F 754420     552            mov Time_soak, #0x20
0662 7545C8     553            mov Temp_refl, #200
0665 754620     554            mov Time_refl, #0x20
0668 754700     555            mov sec, #0
066B 754800     556            mov loop_ten_times, #0
066E            557   
066E C200       558            clr reflow_flag ; start on temp
0670 C201       559            clr soak_flag ; start on temp
0672            560   
0672            561   Forever:
0672            562   
0672            563   
0672            564   ; Example branch for decreasing any given value 
0672            565   ; This set of code will increase the ones columnn of any given 
0672            566   ; variable. ie. reflow_temp_ones, reflow_time_ones
0672            567   ; the 10s and 100s column will update in response to increasing 
0672            568   ; the ones column beyond 9.
0672            569   
0672            570   ; REFLOW ;
0672            571   reflow_toggle:
0672 200A02     572            jb PB7, check_reflow_toggle
0675 B200       573            cpl reflow_flag ; if button is pressed, change flag
0677            574   
0677            575   check_reflow_toggle: 
0677 200010     576            jb reflow_flag, turn_reflow_to_time
067A            577   
067A            578   turn_reflow_to_temp:
067A            579            ; will use the same logic for the other pushbuttons
067A            580   ; This example will use temp_soak for this example
067A            581   
067A            582            decrease_reflow_temp:
067A 200905     583            jb PB6, increase_reflow_temp
067D 1545       584       dec Temp_refl
067F 0206A4     585            ljmp soak_toggle
0682            586            
0682            587            increase_reflow_temp:
0682 20081F     588            jb PB5, soak_toggle 
0685 0545       589            inc Temp_refl
0687 0206A4     590            ljmp soak_toggle
068A            591   
068A            592   
068A            593   turn_reflow_to_time:
068A            594            
068A            595            decrease_reflow_time:
068A 20090A     596            jb PB6, increase_reflow_time
068D E546       597            mov a, Time_refl
068F 2499       598       add a, #0x99
0691 D4         599            da a
0692 F546       600       mov Time_refl, a
0694 0206A4     601            ljmp soak_toggle
0697            602            
0697            603            increase_reflow_time:
0697 20080A     604            jb PB5, soak_toggle 
069A E546       605            mov a, Time_refl
069C 2401       606            add a, #1
069E D4         607            da a 
069F F546       608            mov Time_refl, a
06A1 0206A4     609            ljmp soak_toggle
06A4            610   
06A4            611   ; SOAK ;
06A4            612   soak_toggle:
06A4 200702     613            jb PB4, check_soak_toggle
06A7 B201       614            cpl soak_flag ; if button is pressed, change flag
06A9            615   
06A9            616   check_soak_toggle: 
06A9 200110     617            jb soak_flag, turn_soak_to_time
06AC            618   
06AC            619   turn_soak_to_temp:
06AC            620            ; will use the same logic for the other pushbuttons
06AC            621   ; This example will use temp_soak for this example
06AC            622   
06AC            623            decrease_soak_temp:
06AC 200605     624            jb PB3, increase_soak_temp
06AF 1543       625       dec Temp_soak
06B1 0206D6     626            ljmp start_stop
06B4            627            
06B4            628            increase_soak_temp:
06B4 20051F     629            jb PB2, start_stop 
06B7 0543       630            inc Temp_soak
06B9 0206D6     631            ljmp start_stop
06BC            632   
06BC            633   turn_soak_to_time:
06BC            634            
06BC            635            decrease_soak_time:
06BC 20060A     636            jb PB3, increase_soak_time
06BF E544       637            mov a, Time_soak
06C1 2499       638       add a, #0x99
06C3 D4         639            da a
06C4 F544       640       mov Time_soak, a
06C6 0206D6     641            ljmp start_stop
06C9            642            
06C9            643            increase_soak_time:
06C9 2005D8     644            jb PB2, soak_toggle 
06CC E544       645            mov a, Time_soak
06CE 2401       646            add a, #1
06D0 D4         647            da a 
06D1 F544       648            mov Time_soak, a
06D3 0206D6     649            ljmp start_stop
06D6            650   
06D6            651   start_stop:
06D6 E545       652            mov a, Temp_refl
06D8 C0E0       653            push acc
06DA 7402       653            mov a, #2
06DC 14         653            dec a
06DD 1200E8     653            lcall ?Set_Cursor_2 ; Select column and row
06E0 D0E0       653            pop acc
06E2 120375     654            lcall SendToLCD
06E5 E4         655            clr a
06E6 E544       656            mov a, Time_soak
06E8 C0E0       657            push acc
06EA 7409       657            mov a, #9
06EC 14         657            dec a
06ED 1200E8     657            lcall ?Set_Cursor_2 ; Select column and row
06F0 D0E0       657            pop acc
06F2 120375     658            lcall SendToLCD
06F5 E4         659            clr a
06F6 C0E0       660            push acc
06F8 7406       660            mov a, #6
06FA 14         660            dec a
06FB 1200E8     660            lcall ?Set_Cursor_2 ; Select column and row
06FE D0E0       660            pop acc
0700 C000       661            push ar0
0702 A846       661            mov r0, Time_refl
0704 1200EF     661            lcall ?Display_BCD
0707 D000       661            pop ar0
0709 C0E0       662            push acc
070B 740D       662            mov a, #13
070D 14         662            dec a
070E 1200E8     662            lcall ?Set_Cursor_2 ; Select column and row
0711 D0E0       662            pop acc
0713 C000       663            push ar0
0715 A844       663            mov r0, Time_soak
0717 1200EF     663            lcall ?Display_BCD
071A D000       663            pop ar0
071C 20030F     664            jb PB0, continue
071F            665   
071F            666   turn_on:
071F E54B       667            mov a, FSM1_state
0721 B40005     668            cjne a, #0, turn_off
0724 754B01     669            mov FSM1_state, #1
0727 8005       670            sjmp continue
0729            671   
0729            672   turn_off:
0729 754B00     673            mov FSM1_state, #0
072C 8000       674            sjmp continue
072E            675   
072E            676   
072E            677   continue:
072E 120556     678            lcall ADC_to_PB
0731            679            ;lcall Display_PushButtons_ADC
0731            680            
0731 75E807     681            mov ADCCON0, #0x07 ; Select channel 7 (P1.1)
0734 C2EF       682            clr ADCF
0736 D2EE       683            setb ADCS ;  ADC start trigger signal
0738 30EFFD     684       jnb ADCF, $ ; Wait for conversion complete
073B            685       
073B            686       ; Read the ADC result and store in [R1, R0]
073B E5C3       687       mov a, ADCRH   
073D C4         688       swap a
073E C0E0       689       push acc
0740 540F       690       anl a, #0x0f
0742 F9         691       mov R1, a
0743 D0E0       692       pop acc
0745 54F0       693       anl a, #0xf0
0747 45C2       694       orl a, ADCRL
0749 F8         695       mov R0, A
074A            696       
074A 75E801     697       mov ADCCON0, #0x01 ; Select channel 1 (P3.0)
074D C2EF       698            clr ADCF
074F D2EE       699            setb ADCS ;  ADC start trigger signal
0751 30EFFD     700       jnb ADCF, $ ; Wait for conversion complete
0754            701       
0754            702       ; Read the ADC result and store in [R4, R3]
0754 E5C3       703       mov a, ADCRH   
0756 C4         704       swap a
0757 C0E0       705       push acc
0759 540F       706       anl a, #0x0f
075B FC         707       mov R4, a
075C D0E0       708       pop acc
075E 54F0       709       anl a, #0xf0
0760 45C2       710       orl a, ADCRL
0762 FB         711       mov R3, A
0763            712       
0763            713            ; Convert to LM335 temperature to voltage
0763 8B30       714            mov x+0, R3
0765 8C31       715            mov x+1, R4
0767 753200     716            mov x+2, #0
076A 753300     717            mov x+3, #0
076D 75347C     718            mov y+0, #low (50300 % 0x10000) 
0770 7535C4     718            mov y+1, #high(50300 % 0x10000) 
0773 753600     718            mov y+2, #low (50300 / 0x10000) 
0776 753700     718            mov y+3, #high(50300 / 0x10000)  ; VCC voltage measured
0779 12027F     719            lcall mul32
077C 7534FF     720            mov y+0, #low (4095 % 0x10000) 
077F 75350F     720            mov y+1, #high(4095 % 0x10000) 
0782 753600     720            mov y+2, #low (4095 / 0x10000) 
0785 753700     720            mov y+3, #high(4095 / 0x10000)  ; 2^12-1
0788 12030C     721            lcall div32
078B 7534D0     722            mov y+0, #low (27600 % 0x10000) 
078E 75356B     722            mov y+1, #high(27600 % 0x10000) 
0791 753600     722            mov y+2, #low (27600 / 0x10000) 
0794 753700     722            mov y+3, #high(27600 / 0x10000) 
0797 1201EB     723            lcall sub32
079A 753464     724            mov y+0, #low (100 % 0x10000) 
079D 753500     724            mov y+1, #high(100 % 0x10000) 
07A0 753600     724            mov y+2, #low (100 / 0x10000) 
07A3 753700     724            mov y+3, #high(100 / 0x10000) 
07A6 12027F     725            lcall mul32
07A9            726            
07A9            727            ; Convert to BCD and display
07A9 120105     728            lcall hex2bcd
07AC C0E0       729            push acc
07AE 740C       729            mov a, #12
07B0 14         729            dec a
07B1 1200EA     729            lcall ?Set_Cursor_1 ; Select column and row
07B4 D0E0       729            pop acc
07B6 1203B6     730            lcall Display_formated_BCD_Tj
07B9            731   
07B9            732            ; Convert value back to hex to use for calculations
07B9 12018E     733            lcall bcd2hex
07BC            734   
07BC            735            ; Storing the ambient temperature
07BC 853038     736            mov amb_temp+0, x+0
07BF 853139     737            mov amb_temp+1, x+1
07C2 85323A     738            mov amb_temp+2, x+2
07C5 85333B     739            mov amb_temp+3, x+3
07C8            740   
07C8            741            ; Convert to thermocouple voltage to temperature
07C8 8830       742            mov x+0, R0
07CA 8931       743            mov x+1, R1
07CC 753200     744            mov x+2, #0
07CF 753300     745            mov x+3, #0
07D2 75347C     746            mov y+0, #low (50300 % 0x10000) 
07D5 7535C4     746            mov y+1, #high(50300 % 0x10000) 
07D8 753600     746            mov y+2, #low (50300 / 0x10000) 
07DB 753700     746            mov y+3, #high(50300 / 0x10000)  ; VCC voltage measured
07DE 12027F     747            lcall mul32
07E1 7534FF     748            mov y+0, #low (4095 % 0x10000) 
07E4 75350F     748            mov y+1, #high(4095 % 0x10000) 
07E7 753600     748            mov y+2, #low (4095 / 0x10000) 
07EA 753700     748            mov y+3, #high(4095 / 0x10000)  ; 2^12-1
07ED 12030C     749            lcall div32
07F0 753464     750            mov y+0, #low (100 % 0x10000) 
07F3 753500     750            mov y+1, #high(100 % 0x10000) 
07F6 753600     750            mov y+2, #low (100 / 0x10000) 
07F9 753700     750            mov y+3, #high(100 / 0x10000) 
07FC 12030C     751            lcall div32
07FF 753445     752            mov y+0, #low (5189 % 0x10000) 
0802 753514     752            mov y+1, #high(5189 % 0x10000) 
0805 753600     752            mov y+2, #low (5189 / 0x10000) 
0808 753700     752            mov y+3, #high(5189 / 0x10000) 
080B 12027F     753            lcall mul32
080E            754   
080E            755            ; Adding the ambient temperature to oven temperature
080E 853834     756            mov y+0, amb_temp+0
0811 853935     757            mov y+1, amb_temp+1
0814 853A36     758            mov y+2, amb_temp+2
0817 853B37     759            mov y+3, amb_temp+3
081A 1201CA     760            lcall add32
081D            761            
081D            762            ; Convert to BCD and display
081D 120105     763            lcall hex2bcd
0820 C0E0       764            push acc
0822 7403       764            mov a, #3
0824 14         764            dec a
0825 1200EA     764            lcall ?Set_Cursor_1 ; Select column and row
0828 D0E0       764            pop acc
082A 120391     765            lcall Display_formated_BCD_To
082D            766            ;---------------------------------;
082D            767            ; Send a BCD number to PuTTY      ;
082D            768            ;---------------------------------
                769   	Send_BCD mac
                770   		push ar0
                771   		mov r0, %0
                772   		lcall ?Send_BCD
                773   		pop ar0
                774   	endmac
082D            775            
082D            776            ?Send_BCD:
082D C0E0       777                    push acc
082F            778                    ; Write most significant digit
082F E53F       779                    mov a, bcd+3
0831 C4         780                    swap a
0832 540F       781                    anl a, #0fh
0834 4430       782                    orl a, #30h
0836 120538     783                    lcall putchar
0839            784                    ; write least significant digit
0839 E53F       785                    mov a, bcd+3
083B 540F       786                    anl a, #0fh
083D 4430       787                    orl a, #30h
083F 120538     788                    lcall putchar
0842            789                    
0842            790                    ; Write most significant digit
0842 E53E       791                    mov a, bcd+2
0844 C4         792                    swap a
0845 540F       793                    anl a, #0fh
0847 4430       794                    orl a, #30h
0849 120538     795                    lcall putchar
084C            796                    ; write least significant digit
084C E53E       797                    mov a, bcd+2
084E 540F       798                    anl a, #0fh
0850 4430       799                    orl a, #30h
0852 120538     800                    lcall putchar
0855 D0E0       801                    pop acc
0857            802            ; Write most significant digit
0857 E53D       803                    mov a, bcd+1
0859 C4         804                    swap a
085A 540F       805                    anl a, #0fh
085C 4430       806                    orl a, #30h
085E 120538     807                    lcall putchar
0861            808   
0861            809                    ; Write most significant digit
0861            810   
0861            811            
0861            812            ; Storing the thermocouple temperature into var temp 
0861 753410     813            mov y+0, #low (10000 % 0x10000) 
0864 753527     813            mov y+1, #high(10000 % 0x10000) 
0867 753600     813            mov y+2, #low (10000 / 0x10000) 
086A 753700     813            mov y+3, #high(10000 / 0x10000) 
086D 12030C     814            lcall div32
0870 853049     815            mov temp+0, x+0
0873 85314A     816            mov temp+1, x+1
0876            817            
0876            818   
0876            819   
0876            820            ; Wait 100 ms between readings
0876 7A64       821            mov R2, #100
0878 120550     822            lcall waitms
087B            823            
087B            824   ; STATE MACHINE  
087B            825   FSM1:
087B E54B       826            mov a, FSM1_state
087D            827   
087D            828   ; off state. Should go to state 1 when start button is pressed (Button 8 right now)
087D            829   FSM1_state0:
087D B40028     830            cjne a, #0, FSM1_state1
0880 C0E0       831            push acc
0882 7410       831            mov a, #16
0884 14         831            dec a
0885 1200E8     831            lcall ?Set_Cursor_2 ; Select column and row
0888 D0E0       831            pop acc
088A C083       832            push dph
088C C082       832            push dpl
088E C0E0       832            push acc
0890 900045     832            mov dptr, #state0
0893 1200DD     832            lcall ?Send_Constant_String
0896 D0E0       832            pop acc
0898 D082       832            pop dpl
089A D083       832            pop dph
089C 754100     833            mov pwm, #0
089F 754700     834            mov sec, #0
08A2 754800     835            mov loop_ten_times, #0
08A5            836            ;jb PB0, FSM1_state0_done
08A5            837            ;mov FSM1_state, #1
08A5            838   FSM1_state0_done:
08A5 020672     839            ljmp Forever
08A8            840   
08A8            841   ; pre-heat state. Should go to state two when temp reaches temp_soak     
08A8            842   FSM1_state1:
08A8 B40157     843            cjne a, #1, FSM1_state2
08AB C0E0       844            push acc
08AD 7410       844            mov a, #16
08AF 14         844            dec a
08B0 1200E8     844            lcall ?Set_Cursor_2 ; Select column and row
08B3 D0E0       844            pop acc
08B5 C083       845            push dph
08B7 C082       845            push dpl
08B9 C0E0       845            push acc
08BB 900047     845            mov dptr, #state1
08BE 1200DD     845            lcall ?Send_Constant_String
08C1 D0E0       845            pop acc
08C3 D082       845            pop dpl
08C5 D083       845            pop dph
08C7            846            
08C7 C296       847            clr P1.6
08C9            848            
08C9 754164     849            mov pwm, #100
08CC            850            
08CC            851            ;Failsafe. Returns to state 0 if temperature is not reached in 6 seconds (should be 60 idk how to do it)
08CC E547       852            mov a, sec
08CE 2401       853            add a, #1
08D0 F547       854            mov sec, a
08D2            855   
08D2 743C       856            mov a, #60
08D4 C3         857            clr c
08D5 9547       858            subb a, sec
08D7 5016       859            jnc FSM1_state1_continue
08D9            860   
08D9 E548       861            mov a, loop_ten_times
08DB 2401       862            add a, #1
08DD F548       863            mov loop_ten_times, a
08DF 754700     864            mov sec, #0
08E2 7408       865            mov a, #8
08E4 C3         866            clr c
08E5 9548       867            subb a, loop_ten_times
08E7 5006       868            jnc FSM1_state1_continue
08E9            869   
08E9 754B00     870            mov FSM1_state, #0
08EC 020672     871            ljmp Forever
08EF            872   
08EF            873   FSM1_state1_continue:
08EF            874            ; These two lines are temporary. temp should be read from the thermocouple wire
08EF 754364     875            mov temp_soak, #100
08F2            876            
08F2 E543       877            mov a, temp_soak
08F4 D3         878            setb c
08F5 9549       879            subb a, temp
08F7 5006       880            jnc FSM1_state1_done
08F9 754800     881            mov loop_ten_times, #0
08FC 754B02     882            mov FSM1_state, #2
08FF            883   FSM1_state1_done:
08FF 020672     884            ljmp Forever
0902            885   
0902            886   ; State 2
0902            887   FSM1_state2:
0902 D296       888            setb P1.6 ;speaker
0904 B40245     889            cjne a, #2, FSM1_state3
0907 C0E0       890            push acc
0909 7410       890            mov a, #16
090B 14         890            dec a
090C 1200E8     890            lcall ?Set_Cursor_2 ; Select column and row
090F D0E0       890            pop acc
0911 C083       891            push dph
0913 C082       891            push dpl
0915 C0E0       891            push acc
0917 900049     891            mov dptr, #state2
091A 1200DD     891            lcall ?Send_Constant_String
091D D0E0       891            pop acc
091F D082       891            pop dpl
0921 D083       891            pop dph
0923 754114     892            mov pwm, #20
0926            893            
0926 E547       894            mov a, sec
0928 2401       895            add a, #1
092A F547       896            mov sec, a
092C            897   
092C E544       898            mov a, Time_soak
092E C3         899            clr c
092F 9547       900            subb a, sec
0931 5013       901            jnc FSM1_state2_done
0933            902   
0933 E548       903            mov a, loop_ten_times
0935 2401       904            add a, #1
0937 F548       905            mov loop_ten_times, a
0939 754700     906            mov sec, #0
093C 7408       907            mov a, #8
093E C3         908            clr c
093F 9548       909            subb a, loop_ten_times
0941 5003       910            jnc FSM1_state2_done
0943            911   
0943 754B03     912            mov FSM1_state, #3
0946            913   FSM1_state2_done:
0946 020672     914            ljmp Forever
0949            915   
0949            916   ;DELETE
0949            917   jump:
0949 02087D     918   ljmp FSM1_state0         
094C            919   
094C            920   ;State 3
094C            921   FSM1_state3:
094C B40332     922            cjne a, #3, FSM1_state4
094F C0E0       923            push acc
0951 7410       923            mov a, #16
0953 14         923            dec a
0954 1200E8     923            lcall ?Set_Cursor_2 ; Select column and row
0957 D0E0       923            pop acc
0959 C083       924            push dph
095B C082       924            push dpl
095D C0E0       924            push acc
095F 90004B     924            mov dptr, #state3
0962 1200DD     924            lcall ?Send_Constant_String
0965 D0E0       924            pop acc
0967 D082       924            pop dpl
0969 D083       924            pop dph
096B 754164     925            mov pwm, #100
096E 754700     926            mov sec, #0
0971 754800     927            mov loop_ten_times, #0
0974            928            
0974            929            
0974 E545       930            mov a, Temp_refl
0976 C3         931            clr c
0977 9549       932            subb a, temp
0979 5003       933            jnc FSM1_state3_done
097B 754B04     934            mov FSM1_state, #4
097E            935   FSM1_state3_done:
097E 020672     936            ljmp Forever
0981            937   
0981            938   
0981            939   ;State 4
0981            940   FSM1_state4:
0981 B40442     941            cjne a, #4, FSM1_state5
0984 C0E0       942            push acc
0986 7410       942            mov a, #16
0988 14         942            dec a
0989 1200E8     942            lcall ?Set_Cursor_2 ; Select column and row
098C D0E0       942            pop acc
098E C083       943            push dph
0990 C082       943            push dpl
0992 C0E0       943            push acc
0994 90004D     943            mov dptr, #state4
0997 1200DD     943            lcall ?Send_Constant_String
099A D0E0       943            pop acc
099C D082       943            pop dpl
099E D083       943            pop dph
09A0 754114     944            mov pwm, #20
09A3            945            
09A3 E547       946            mov a, sec
09A5 2401       947            add a, #1
09A7 F547       948            mov sec, a
09A9            949            
09A9 E546       950            mov a, Time_refl
09AB C3         951            clr c
09AC 9547       952            subb a,sec
09AE 5013       953            jnc FSM1_state4_done
09B0            954   
09B0 E548       955            mov a, loop_ten_times
09B2 2401       956            add a, #1
09B4 F548       957            mov loop_ten_times, a
09B6 754700     958            mov sec, #0
09B9 7408       959            mov a, #8
09BB C3         960            clr c
09BC 9548       961            subb a, loop_ten_times
09BE 5003       962            jnc FSM1_state4_done
09C0            963   
09C0 754B05     964            mov FSM1_state, #5
09C3            965   FSM1_state4_done:
09C3 020672     966            ljmp Forever
09C6            967            
09C6            968   FSM1_state5:
09C6 B40580     969            cjne a, #5, jump
09C9 C0E0       970            push acc
09CB 7410       970            mov a, #16
09CD 14         970            dec a
09CE 1200E8     970            lcall ?Set_Cursor_2 ; Select column and row
09D1 D0E0       970            pop acc
09D3 C083       971            push dph
09D5 C082       971            push dpl
09D7 C0E0       971            push acc
09D9 90004F     971            mov dptr, #state5
09DC 1200DD     971            lcall ?Send_Constant_String
09DF D0E0       971            pop acc
09E1 D082       971            pop dpl
09E3 D083       971            pop dph
09E5 754100     972            mov pwm, #0
09E8            973            
09E8            974            
09E8 743C       975            mov a, #60
09EA C3         976            clr c
09EB 9549       977            subb a, temp
09ED 4003       978            jc FSM1_state5_done
09EF 754B00     979            mov FSM1_state,#0
09F2            980   FSM1_state5_done:
09F2 120468     981            lcall Save_Variables ; Save variables in flash memory
09F5 020672     982            ljmp Forever
09F8            983            
09F8            984   
09F8            985   
09F8            986   ;Any additions to be checked
09F8            987   EN
